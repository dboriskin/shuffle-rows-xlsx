import base64
import io
import logging
import os
import pandas as pd
import tempfile
from aiogram import Bot, Dispatcher, types, F
from aiogram.enums import ParseMode
from aiogram.types import FSInputFile
from aiogram.webhook.aiohttp_server import SimpleRequestHandler, setup_application
from aiohttp import web

API_TOKEN = os.getenv("TOKEN")
WEBHOOK_PATH = "/webhook"
WEBHOOK_URL = os.getenv("WEBHOOK_URL") + WEBHOOK_PATH

bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# === ÐÐ¾Ð²Ñ‹Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½ XLSX Ð² base64 ===
EXCEL_TEMPLATE_BASE64 = """
UEsDBBQABgAIAAAAIQBBN4LPbgEAAAQFAAATAAgCW0NvbnRlbnRfVHlwZXNdLnhtbCCiBAIooAAC
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACs
VMluwjAQvVfqP0S+Vomhh6qqCBy6HFsk6AeYeJJYJLblGSj8fSdmUVWxCMElUWzPWybzPBit2iZZ
QkDjbC76WU8kYAunja1y8T39SJ9FgqSsVo2zkIs1oBgN7+8G07UHTLjaYi5qIv8iJRY1tAoz58Hy
TulCq4g/QyW9KuaqAvnY6z3JwlkCSyl1GGI4eINSLRpK3le8vFEyM1Ykr5tzHVUulPeNKRSxULm0
+h9J6srSFKBdsWgZOkMfQGmsAahtMh8MM4YJELExFPIgZ4AGLyPdusq4MgrD2nh8YOtHGLqd4662
dV/8O4LRkIxVoE/Vsne5auSPC/OZc/PsNMilrYktylpl7E73Cf54GGV89W8spPMXgc/oIJ4xkPF5
vYQIc4YQad0A3rrtEfQcc60C6Anx9FY3F/AX+5QOjtQ4OI+c2gCXd2EXka469QwEgQzsQ3Jo2PaM
HPmr2w7dnaJBH+CW8Q4b/gIAAP//AwBQSwMEFAAGAAgAAAAhALVVMCP0AAAATAIAAAsACAJfcmVs
cy8ucmVscyCiBAIooAACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAACskk1PwzAMhu9I/IfI99XdkBBCS3dBSLshVH6ASdwPtY2jJBvdvyccEFQa
gwNHf71+/Mrb3TyN6sgh9uI0rIsSFDsjtnethpf6cXUHKiZylkZxrOHEEXbV9dX2mUdKeSh2vY8q
q7iooUvJ3yNG0/FEsRDPLlcaCROlHIYWPZmBWsZNWd5i+K4B1UJT7a2GsLc3oOqTz5t/15am6Q0/
iDlM7NKZFchzYmfZrnzIbCH1+RpVU2g5abBinnI6InlfZGzA80SbvxP9fC1OnMhSIjQS+DLPR8cl
oPV/WrQ08cudecQ3CcOryPDJgosfqN4BAAD//wMAUEsDBBQABgAIAAAAIQCCEBojEQMAANoGAAAP
AAAAeGwvd29ya2Jvb2sueG1srFXdbpw4GL1fad8B+Z4YM+AZUEjFDEQbqa2ibtpeVh7wDFbAZm2T
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
JgMAAHIoAAAAAA==
""".strip()

MAPPING = {
    "Ð’Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð¢Ð¡ Ð½Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ": "Ð’Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð¢Ð¡ Ð½Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ",
    "ÐžÐºÐ½Ð¾ Ð²Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ¸": "Ð’Ñ€ÐµÐ¼Ñ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð¢Ð¡ Ð½Ð° Ñ€Ð°Ð·Ð³Ñ€ÑƒÐ·ÐºÑƒ",
    "ÐšÐ¾ÑÑ‚ Ñ†ÐµÐ½Ñ‚Ñ€": "Ð’Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð·Ð°ÐºÐ°Ð·Ñ‡Ð¸Ðº",
    "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ": "ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ",
    "ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ": "ÐžÑ€Ð³Ð°Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ",
    "ÐÐ´Ñ€ÐµÑ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸": "ÐÐ´Ñ€ÐµÑ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",
    "ÐÐ´Ñ€ÐµÑ Ñ€Ð°Ð·Ð³Ñ€ÑƒÐ·ÐºÐ¸": "ÐÐ´Ñ€ÐµÑ Ñ€Ð°Ð·Ð³Ñ€ÑƒÐ·ÐºÐ¸",
    "Ð¢Ð¸Ð¿ Ð³Ñ€ÑƒÐ·Ð¾Ð²Ñ‹Ñ… Ð¼ÐµÑÑ‚": "ÐÐ° Ð¿Ð°Ð»Ð»ÐµÑ‚Ð°Ñ…",
    "ÐžÐ±ÑŠÐµÐ¼ Ð¿Ð»Ð°Ð½, Ð¼3 (Ð¢Ð¡)": "ÐžÐ±ÑŠÐµÐ¼, ÐºÑƒÐ± Ð¼",
    "ÐšÐ¾Ð»-Ð²Ð¾ Ð¼ÐµÑÑ‚ (Ð¢Ð¡)": "ÐšÐ¾Ð»-Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²Ñ‹Ñ… Ð¼ÐµÑÑ‚",
    "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð»Ð¸ ÐŸÐ Ð ?": "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð»Ð¸ ÐŸÐ Ð ?",
    "Ð§Ð°ÑÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹": "Ð§Ð°ÑÑ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹",
    "ÐšÐ¾Ð»-Ð²Ð¾ ÐµÐ´Ð¸Ð½Ð¸Ñ† Ñ‚Ð¾Ð²Ð°Ñ€Ð°": "ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐµÐ´Ð¸Ð½Ð¸Ñ† Ñ‚Ð¾Ð²Ð°Ñ€Ð°",
    "ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸": "ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸"
}

SPECIAL_COLUMNS = ["ÐœÐ°Ñ€ÐºÐ° Ð¢Ð¡", "ÐÐ¾Ð¼ÐµÑ€ Ð¢Ð¡", "ÐÐ¾Ð¼ÐµÑ€ Ð¿Ñ€Ð¸Ñ†ÐµÐ¿Ð°", "ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"]

def clean_string(x):
    if isinstance(x, str):
        return x.strip()
    return x

def decode_template():
    data = base64.b64decode(EXCEL_TEMPLATE_BASE64)
    return io.BytesIO(data)

@dp.message(F.document)
async def handle_file(message: types.Message):
    await message.answer("ðŸ“¥ ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»...")
    file_info = await bot.get_file(message.document.file_id)
    downloaded_file = await bot.download_file(file_info.file_path)

    df_input = pd.read_excel(downloaded_file).applymap(clean_string)

    # Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑˆÐ°Ð±Ð»Ð¾Ð½
    template_bytes = decode_template()
    df_template = pd.read_excel(template_bytes)

    df_output = pd.DataFrame(columns=df_template.columns)

    for column in df_output.columns:
        if column in MAPPING:
            src_col = MAPPING[column]
            if src_col in df_input.columns:
                df_output[column] = df_input[src_col]
            else:
                df_output[column] = ""
        elif column in SPECIAL_COLUMNS:
            if column == "ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹":
                driver_rows = df_input["ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"].dropna().str.extract(r'([Ð-Ð¯Ð°-ÑÐÑ‘A-Za-z\s]+),?\s*(\+?\d[\d\- \(\)]{7,})?')
                df_output["Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ"] = driver_rows[0].fillna("")
                df_output["ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹"] = driver_rows[1].fillna("")
            else:
                if column in df_input.columns:
                    df_output[column] = df_input[column].fillna("")
                else:
                    df_output[column] = ""

    with tempfile.NamedTemporaryFile(suffix=".xlsx", delete=False) as tmp:
        df_output.to_excel(tmp.name, index=False)
        await message.answer_document(FSInputFile(tmp.name, filename="output.xlsx"))

async def on_startup(bot: Bot) -> None:
    await bot.set_webhook(WEBHOOK_URL)

app = web.Application()
SimpleRequestHandler(dispatcher=dp, bot=bot).register(app, path=WEBHOOK_PATH)
setup_application(app, dp, bot=bot, on_startup=on_startup)

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    web.run_app(app, host="0.0.0.0", port=int(os.getenv("PORT", default=8080)))